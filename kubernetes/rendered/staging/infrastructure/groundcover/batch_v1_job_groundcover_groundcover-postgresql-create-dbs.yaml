# Source: groundcover-wrapper/charts/groundcover/charts/backend/templates/postgresql/hooks.yaml
apiVersion: batch/v1
kind: Job
metadata:
  name: groundcover-postgresql-create-dbs
  namespace: groundcover
  annotations:
    helm.sh/hook-weight: "0"
    helm.sh/hook: post-upgrade
    helm.sh/hook-delete-policy: before-hook-creation
spec:
  template:
    spec:
      restartPolicy: OnFailure
      imagePullSecrets: []
      initContainers:
        - name: wait-for-db
          image: public.ecr.aws/groundcovercom/bitnami/postgresql:15.3.0-debian-11-r75
          env:
            - name: PGPASSWORD
              valueFrom:
                secretKeyRef:
                  name: groundcover-postgresql
                  key: postgres-password
            - name: PGHOST
              value: groundcover-postgresql
            - name: PGPORT
              value: "5432"
          command:
            - /bin/bash
            - -c
            - |
              set -eu
              . /opt/bitnami/scripts/libautoctl.sh
              wait_until_can_connect "postgres://postgres:${PGPASSWORD}@${PGHOST}:${PGPORT}/postgres"
      containers:
        - name: psql
          image: public.ecr.aws/groundcovercom/bitnami/postgresql:15.3.0-debian-11-r75
          command:
            - /bin/sh
            - -c
            - "set -eu \n\n. /create-dbs/10-create-dbs.sh\n. /create-dbs/11-create-keep-user.sh\n"
          env:
            - name: POSTGRES_KEEP_USER
              valueFrom:
                secretKeyRef:
                  optional: true
                  name: keep-postgres
                  key: username
            - name: POSTGRES_KEEP_DB
              valueFrom:
                secretKeyRef:
                  optional: true
                  name: keep-postgres
                  key: database
            - name: POSTGRES_KEEP_PASSWORD
              valueFrom:
                secretKeyRef:
                  optional: true
                  name: keep-postgres
                  key: password
            - name: POSTGRES_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: groundcover-postgresql
                  key: postgres-password
            - name: INITDB_PGHOST
              value: groundcover-postgresql
            - name: INITDB_PGPORT
              value: "5432"
          volumeMounts:
            - mountPath: /create-dbs
              name: create-dbs
      volumes:
        - name: create-dbs
          configMap:
            name: groundcover-postgresql-init-scripts
