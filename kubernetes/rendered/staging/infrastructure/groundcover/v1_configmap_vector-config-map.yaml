# Source: groundcover-wrapper/charts/groundcover/templates/vector/configmap.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: vector-config-map
  labels:
    app.kubernetes.io/part-of: groundcover
    app: vector
    app.kubernetes.io/name: vector
data:
  vector.yaml: "api:\n  address: 0.0.0.0:8686\n  enabled: true\n  graphql: false\n  playground: false\n\n\nsources:\n  telemetry_metrics:\n    type: internal_metrics\n\n\n  otel_logs:\n    grpc:\n      address: 0.0.0.0:4317\n    http:\n      address: 0.0.0.0:4318\n      keepalive:\n        max_connection_age_jitter_factor: 0.1\n        max_connection_age_secs: 300\n    type: opentelemetry\n  otel_logs_custom:\n    grpc:\n      address: 0.0.0.0:4337\n    http:\n      address: 0.0.0.0:4338\n      keepalive:\n        max_connection_age_jitter_factor: 0.1\n        max_connection_age_secs: 300\n    type: opentelemetry\n  otel_logs_monitors:\n    grpc:\n      address: 0.0.0.0:4347\n    http:\n      address: 0.0.0.0:4348\n      keepalive:\n        max_connection_age_jitter_factor: 0.1\n        max_connection_age_secs: 300\n    type: opentelemetry\n  otel_traces:\n    grpc:\n      address: 0.0.0.0:4327\n    http:\n      address: 0.0.0.0:4328\n      keepalive:\n        max_connection_age_jitter_factor: 0.1\n        max_connection_age_secs: 300\n    type: opentelemetry\n  json_entities:\n    address: 0.0.0.0:4369\n    decoding:\n      codec: json\n    path: \"\"\n    strict_path: false\n    type: http\n  json_events:\n    address: 0.0.0.0:4359\n    decoding:\n      codec: json\n    path: \"\"\n    strict_path: false\n    type: http\n  json_logs:\n    address: 0.0.0.0:4319\n    decoding:\n      codec: json\n    path: \"\"\n    strict_path: false\n    type: http\n  json_measurements:\n    address: 0.0.0.0:4379\n    decoding:\n      codec: json\n    path: \"\"\n    strict_path: false\n    type: http\n  json_monitors:\n    address: 0.0.0.0:4349\n    decoding:\n      codec: json\n    path: \"\"\n    strict_path: false\n    type: http\n  json_table_write:\n    address: 0.0.0.0:4350\n    decoding:\n      codec: json\n    method: POST\n    path: '/ingest/v2/json/table/write'\n    strict_path: false\n    type: http\n  json_traces:\n    address: 0.0.0.0:4329\n    decoding:\n      codec: json\n    path: \"\"\n    strict_path: false\n    type: http\n  statsd_tcp:\n    address: 0.0.0.0:8125\n    mode: tcp\n    type: statsd\n  statsd_udp:\n    address: 0.0.0.0:8125\n    mode: udp\n    type: statsd\n  vm_metrics:\n    address: 0.0.0.0:4599\n    mode: tcp\n    type: prometheus_remote_write\n  emptySource:\n    exclude:\n    - /*\n    include:\n    - /non_exiding_dir/non_existing_file\n    type: file\n\n\ntransforms:\n  enriched_telemetry_metrics:\n    type: remap\n    inputs:\n        - telemetry_metrics\n    source: |-\n  \n      .tags.vector_type = \"backend\"\n  \n\n\n  custom_from_logs:\n    inputs:\n    - otel_logs_custom.logs\n    source: . = .attributes\n    type: remap\n  custom_from_logs_routing:\n    inputs:\n    - custom_from_logs\n    reroute_unmatched: true\n    route:\n      entities: .log_type == \"entity\"\n      measurements: .log_type == \"measurement\"\n    type: route\n  entities:\n    inputs:\n    - custom_from_logs_routing.entities\n    source: \"\"\n    type: remap\n  events:\n    inputs:\n    - custom_from_logs_routing._unmatched\n    source: .type = del(.event_type)\n    type: remap\n  logs_from_logs:\n    inputs:\n    - otel_logs.logs\n    source: |-\n      .attributes, err = object(.attributes)\n      if err == null {\n        if exists(.message) {\n          message, err = string(.message)\n          if err == null && strlen(message) > 0 {\n            .attributes.body = message\n          }\n        }\n  \n        if exists(.resources) {\n          .resources, err = object(.resources)\n          if err == null {\n            .attributes = merge(.attributes, .resources, true)\n          }\n        }\n  \n        . = .attributes\n      } else {\n        log(\"Recieved non-object attributes, skipping\", level: \"error\")\n      }\n    type: remap\n  measurements:\n    inputs:\n    - custom_from_logs_routing.measurements\n    source: \"\"\n    type: remap\n  metrics_metadata_extracted:\n    inputs:\n    - throttled_metrics_metadata_to_logs\n    source: |-\n      . =  {\n        \"timestamp\": .timestamp,\n        \"cluster\": .tags.clusterId,\n        \"env\": .tags.env,\n        \"namespace\": .tags.namespace,\n        \"name\": .name,\n        \"tags\": .tags\n      }\n    type: remap\n  metrics_metadata_to_logs:\n    inputs:\n    - vm_metrics\n    type: metric_to_log\n  monitors:\n    inputs:\n    - otel_logs_monitors.logs\n    source: \". = .attributes\\ndel(.condition)\\ndel(.dashboardUID)\\ndel(.folderUID)\\ndel(.grafana_folder)\\ndel(.from)\\ndel(.group)\\ndel(.orgID)\\ndel(.panelID)\\ndel(.ruleUID)\\n.evaluation_error\n      = .error\\ndel(.error)\\n.evaluation_duration_seconds = .evaluationDurationSeconds\\ndel(.evaluationDurationSeconds)\\n.silence_ids\n      = .silenceIds\\ndel(.silenceIds)\\n.previous_state, err = to_string(del(.previous))\\nif\n      err == null {\\n  .previous_state = to_string(split(.previous_state, \\\"(\\\", 2)[0])\\n\n      \\ .previous_state = strip_whitespace(.previous_state)\\n}\\n.state, err = to_string(del(.current))\\nif\n      err == null {\\n  .state = to_string(split(.state, \\\"(\\\", 2)[0])\\n  .state = strip_whitespace(.state)\\n}\\n.cluster\n      = get!(value: .labels, path: [\\\"cluster\\\"])\\nif .cluster == \\\"\\\" {\\n  .cluster\n      = get!(value: .labels, path: [\\\"clusterId\\\"])\\n}\\n.env = get!(value: .labels,\n      path: [\\\"env\\\"])\\n.namespace = get!(value: .labels, path: [\\\"namespace\\\"])\\n.workload\n      = get!(value: .labels, path: [\\\"workload\\\"])\\nif .workload == \\\"\\\" {\\n  .workload\n      = get!(value: .labels, path: [\\\"workload_name\\\"])\\n} \\n.pod = get!(value: .labels,\n      path: [\\\"pod\\\"])\\nif .pod == \\\"\\\" {\\n  .pod = get!(value: .labels, path: [\\\"pod_name\\\"])\\n}\\n.category\n      = get!(value: .labels, path: [\\\"category\\\"])\\n.severity = get!(value: .labels,\n      path: [\\\"_gc_severity\\\"])\\n.measurement_type = get!(value: .annotations, path:\n      [\\\"_gc_measurement_type\\\"])\\ndel(.annotations)\"\n    type: remap\n  table_write_routing:\n    inputs:\n    - json_table_write\n    reroute_unmatched: false\n    route:\n      aws_billing_report: .path == \"/ingest/v2/json/table/write/aws_billing_report\"\n      metrics_metadata: .path == \"/ingest/v2/json/table/write/metrics_metadata\"\n    type: route\n  throttled_metrics_metadata_to_logs:\n    inputs:\n    - metrics_metadata_to_logs\n    threshold: 1000\n    type: throttle\n    window_secs: 1\n  traces_from_logs:\n    inputs:\n    - otel_traces.logs\n    source: . = .attributes\n    type: remap\n\n  dropOldLogs:\n    inputs:\n\n    - logs_from_logs\n    - json_logs\n\n\n    condition: |\n      to_unix_timestamp(now()) - 12*3600 < to_unix_timestamp(parse_timestamp(.timestamp, \"%+\") ?? from_unix_timestamp!(0))\n    type: filter\n\n\n\n\n \n  logs_to_events_transform:\n    inputs:\n    - emptySource\n    \n    source: |-\n      if !exists(.event_type) {\n        abort \"no event_type for custom event\"\n      }\n      . = {\n        \"event_id\": .guid,\n        \"first_timestamp\": .timestamp,\n        \"last_timestamp\": .timestamp,\n        \"created_timestamp\": .timestamp,\n        \"seen_timestamp\": .timestamp,\n        \"timestamp\": .timestamp,\n        \"env\": .env,\n        \"source\": .source,\n        \"is_external\": false,\n        \"entity_uid\": .pod_uid,\n        \"entity_name\": .pod_name,\n        \"entity_kind\": \"pod\",\n        \"entity_namespace\": .namespace,\n        \"entity_workload\": .workload,\n        \"category\": \"custom\",\n        \"type\": .event_type,\n        \"severity\": \"\",\n        \"k8s_event_uid\": \"\",\n        \"k8s_reason\": \"\",\n        \"reason\": \"\",\n        \"k8s_message\": \"\",\n        \"message\": .content,\n        \"count\": 1,\n        \"raw\": .content,\n        \"string_attributes\": .string_attributes,\n        \"float_attributes\": .float_attributes,\n        \"cluster\": .cluster,\n        \"env_name\": .env,\n      }\n    type: remap\n\n\n\nsinks:\n\n  telemtry_prometheus_sink:\n          type: prometheus_exporter\n          inputs:\n            - enriched_telemetry_metrics\n\n  custom_metrics_sink:\n    endpoint: 'http://groundcover-metrics-ingester:8429/api/v1/write'\n    healthcheck:\n      enabled: false\n    inputs:\n    - statsd_udp\n    - statsd_tcp\n    type: prometheus_remote_write\n\n  clickhouse_metrics_metadata:\n    auth:\n      password: $CLICKHOUSE_PASSWORD\n      strategy: basic\n      user: 'default'\n    batch:\n      max_bytes: 100000000\n      max_events: 10000\n      timeout_secs: 2\n    buffer:\n      max_events: 5000\n      type: memory\n      when_full: drop_newest\n    database: groundcover\n    date_time_best_effort: true\n    encoding:\n      timestamp_format: rfc3339\n    endpoint: 'http://groundcover-clickhouse-shard0-0-external:8123'\n    format: json_each_row\n    healthcheck:\n      enabled: false\n    inputs:\n    - metrics_metadata_extracted\n    - table_write_routing.metrics_metadata\n    request:\n      retry_attempts: 5\n    table: metrics_metadata\n    type: clickhouse\n  clickhouse_aws_billing_report:\n    auth:\n      password: $CLICKHOUSE_PASSWORD\n      strategy: basic\n      user: 'default'\n    batch:\n      max_bytes: 100000000\n      max_events: 10000\n      timeout_secs: 2\n    buffer:\n      max_events: 50000\n      type: memory\n      when_full: drop_newest\n    database: groundcover\n    date_time_best_effort: true\n    encoding:\n      timestamp_format: rfc3339\n    endpoint: 'http://groundcover-clickhouse-shard0-0-external:8123'\n    format: json_each_row\n    healthcheck:\n      enabled: false\n    inputs:\n    - table_write_routing.aws_billing_report\n    request:\n      retry_attempts: 5\n    table: aws_billing_report\n    type: clickhouse\n\n  clickhouse_logs:\n    inputs:\n    \n    \n    - dropOldLogs\n    \n    \n    auth:\n      password: $CLICKHOUSE_PASSWORD\n      strategy: basic\n      user: 'default'\n    batch:\n      max_bytes: 200000000\n      max_events: 200000\n      timeout_secs: 1\n    buffer:\n      max_events: 50000\n      type: memory\n      when_full: drop_newest\n    database: groundcover\n    date_time_best_effort: true\n    encoding:\n      timestamp_format: rfc3339\n    endpoint: 'http://groundcover-clickhouse-shard0-0-external:8123'\n    format: json_each_row\n    request:\n      retry_attempts: 5\n    table: logs_v6\n    type: clickhouse\n\n\n  clickhouse_traces:\n    inputs:\n    \n    \n        - traces_from_logs\n        - json_traces\n    \n    \n    auth:\n      password: $CLICKHOUSE_PASSWORD\n      strategy: basic\n      user: 'default'\n    batch:\n      max_bytes: 200000000\n      max_events: 10000\n      timeout_secs: 1\n    buffer:\n      max_events: 5000\n      type: memory\n      when_full: drop_newest\n    database: groundcover\n    date_time_best_effort: true\n    encoding:\n      timestamp_format: rfc3339\n    endpoint: 'http://groundcover-clickhouse-shard0-0-external:8123'\n    format: json_each_row\n    request:\n      retry_attempts: 5\n    table: traces_v2\n    type: clickhouse\n\n\n  clickhouse_k8s_entities:\n    auth:\n      password: $CLICKHOUSE_PASSWORD\n      strategy: basic\n      user: 'default'\n    batch:\n      max_bytes: 100000000\n      max_events: 10000\n      timeout_secs: 2\n    buffer:\n      max_events: 5000\n      type: memory\n      when_full: drop_newest\n    database: groundcover\n    date_time_best_effort: true\n    encoding:\n      timestamp_format: rfc3339\n    endpoint: 'http://groundcover-clickhouse-shard0-0-external:8123'\n    format: json_each_row\n    inputs:\n    - entities\n    - json_entities\n    request:\n      retry_attempts: 5\n    table: entities_v1\n    type: clickhouse\n  clickhouse_measurements:\n    auth:\n      password: $CLICKHOUSE_PASSWORD\n      strategy: basic\n      user: 'default'\n    batch:\n      max_bytes: 100000000\n      max_events: 10000\n      timeout_secs: 2\n    buffer:\n      max_events: 5000\n      type: memory\n      when_full: drop_newest\n    database: groundcover\n    date_time_best_effort: true\n    encoding:\n      timestamp_format: rfc3339\n    endpoint: 'http://groundcover-clickhouse-shard0-0-external:8123'\n    format: json_each_row\n    inputs:\n    - measurements\n    - json_measurements\n    request:\n      retry_attempts: 5\n    table: measurements\n    type: clickhouse\n  clickhouse_k8s_events:\n    auth:\n      password: $CLICKHOUSE_PASSWORD\n      strategy: basic\n      user: 'default'\n    batch:\n      max_bytes: 100000000\n      max_events: 10000\n      timeout_secs: 2\n    buffer:\n      max_events: 5000\n      type: memory\n      when_full: drop_newest\n    database: groundcover\n    date_time_best_effort: true\n    encoding:\n      timestamp_format: rfc3339\n    endpoint: 'http://groundcover-clickhouse-shard0-0-external:8123'\n    format: json_each_row\n    inputs:\n    - events\n    - json_events\n    - logs_to_events_transform\n    request:\n      retry_attempts: 5\n    table: events_v2\n    type: clickhouse\n  clickhouse_monitors:\n    auth:\n      password: $CLICKHOUSE_PASSWORD\n      strategy: basic\n      user: 'default'\n    batch:\n      max_bytes: 100000000\n      max_events: 10000\n      timeout_secs: 2\n    buffer:\n      max_events: 5000\n      type: memory\n      when_full: drop_newest\n    database: groundcover\n    date_time_best_effort: true\n    encoding:\n      timestamp_format: rfc3339\n    endpoint: 'http://groundcover-clickhouse-shard0-0-external:8123'\n    format: json_each_row\n    inputs:\n    - monitors\n    - json_monitors\n    request:\n      retry_attempts: 5\n    table: monitor_state_v1\n    type: clickhouse\n"
