# Source: groundcover-wrapper/charts/groundcover/templates/backend/db-manager/deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  annotations:
    groundcover_version: 1.11.61
  labels:
    app.kubernetes.io/part-of: groundcover
    app: db-manager
  name: db-manager
  namespace: groundcover
spec:
  strategy:
    type: Recreate
  selector:
    matchLabels:
      app: db-manager
  replicas: 1
  template:
    metadata:
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "9102"
        groundcover_version: 1.11.61
        checksum/config: 98078ca1565c33de7deac06ad16fe9d43310bf8021d95008a48ecaa002cd3570
      labels:
        app: db-manager
        app.kubernetes.io/name: db-manager
        app.kubernetes.io/part-of: groundcover
    spec:
      imagePullSecrets: []
      serviceAccountName: db-manager
      containers:
        - env:
            - name: GC_GROUNDCOVERVERSION
              valueFrom:
                fieldRef:
                  fieldPath: metadata.annotations['groundcover_version']
            - name: GC_CLICKHOUSE_PASS
              valueFrom:
                secretKeyRef:
                  key: admin-password
                  name: groundcover-clickhouse
          image: public.ecr.aws/groundcovercom/db-manager:1.11.61
          imagePullPolicy: Always
          name: db-manager
          ports:
            - containerPort: 9102
              name: metrics
            - containerPort: 8888
              name: http
          resources:
            limits:
              memory: 1Gi
            requests:
              cpu: 15m
              memory: 15Mi
          volumeMounts:
            - mountPath: /config
              name: db-manager-config-volume
      initContainers:
        - args:
            - while [ $(curl -sw '%{http_code}' http://groundcover-clickhouse:8123/ping -o /dev/null) -ne 200 ]; do echo 'Waiting for Clickhouse...'; sleep 2; done; echo Clickhouse is up
          command:
            - /bin/sh
            - -c
          image: public.ecr.aws/groundcovercom/curl:8.6.0
          name: check-ch-ready
      volumes:
        - configMap:
            name: db-manager-config
          name: db-manager-config-volume
