# Source: groundcover-wrapper/charts/groundcover/charts/opentelemetry-collector/templates/configmap.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: groundcover-opentelemetry-collector
  namespace: groundcover
  labels:
    helm.sh/chart: opentelemetry-collector-0.122.0
    app.kubernetes.io/name: opentelemetry-collector
    app.kubernetes.io/instance: groundcover
    app.kubernetes.io/version: 0.123.1
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/part-of: groundcover
data:
  relay: |
    connectors:
      groundcover/traces2logs: {}
    exporters:
      debug: {}
      otlphttp/vector_custom:
        endpoint: 'http://groundcover-vector:4338'
        tls:
          insecure: true
      otlphttp/vector_logs:
        endpoint: 'http://groundcover-vector:4318'
        tls:
          insecure: true
      otlphttp/vector_monitors:
        endpoint: 'http://groundcover-vector:4348'
        tls:
          insecure: true
      otlphttp/vector_traces:
        endpoint: 'http://groundcover-vector:4328'
        tls:
          insecure: true
      prometheusremotewrite:
        endpoint: 'http://groundcover-metrics-ingester:8429/api/v1/write'
        resource_to_telemetry_conversion:
          enabled: true
        tls:
          insecure: true
    extensions:
      health_check:
        endpoint: '0.0.0.0:13133'
        path: /health
        tls: ${env:TLS_CONFIG}
      pprof:
        endpoint: '0.0.0.0:1777'
    processors:
      batch: {}
      batch/custom:
        send_batch_size: 1000
        timeout: 5s
      batch/logs:
        send_batch_size: 20000
        timeout: 1s
      batch/monitorState:
        send_batch_size: 1000
        timeout: 5s
      batch/traces:
        send_batch_size: 5000
        timeout: 1s
      groundcover/custom:
        type: custom
      groundcover/logs:
        type: logs
      groundcover/monitorState:
        type: monitorState
      groundcover/traces: {}
      memory_limiter:
        check_interval: 5s
        limit_percentage: 80
        spike_limit_percentage: 25
      resource/enrich_headers:
        attributes:
        - action: upsert
          from_context: x-groundcover-env-name
          key: env_name
        - action: upsert
          from_context: x-groundcover-service-name
          key: service.name
        - action: upsert
          from_context: x-groundcover-env-type
          key: gc_env_type
    receivers:
      awsfirehose:
        endpoint: '0.0.0.0:4433'
        record_type: cwlogs
      datadog:
        endpoint: '0.0.0.0:8126'
      faro:
        http:
          cors:
            allowed_headers:
            - '*'
            allowed_origins:
            - '*'
          endpoint: '0.0.0.0:12347'
          tls: ${env:TLS_CONFIG}
      http:
        endpoint: 0.0.0.0:8016
      jaeger:
        protocols:
          grpc:
            endpoint: ${env:MY_POD_IP}:14250
          thrift_compact:
            endpoint: ${env:MY_POD_IP}:6831
          thrift_http:
            endpoint: ${env:MY_POD_IP}:14268
      loki:
        protocols:
          http:
            endpoint: '0.0.0.0:3100'
            tls: ${env:TLS_CONFIG}
        use_incoming_timestamp: true
      loki/historian:
        protocols:
          http:
            endpoint: '0.0.0.0:3500'
            tls: ${env:TLS_CONFIG}
        use_incoming_timestamp: true
      otlp:
        protocols:
          grpc:
            endpoint: '0.0.0.0:4317'
            max_recv_msg_size_mib: 50
            tls: ${env:TLS_CONFIG}
          http:
            cors:
              allowed_headers:
              - '*'
              allowed_origins:
              - '*'
            endpoint: '0.0.0.0:4318'
            include_metadata: true
            tls: ${env:TLS_CONFIG}
      otlp/dummy_receiver:
        protocols:
          http:
            endpoint: localhost:9999
      prometheus:
        config:
          scrape_configs:
          - job_name: opentelemetry-collector
            scrape_interval: 10s
            static_configs:
            - targets:
              - ${env:MY_POD_IP}:8888
      rum/events:
        endpoint: 0.0.0.0:8026
        rum_data_type: events
      rum/logs:
        endpoint: 0.0.0.0:8026
        rum_data_type: logs
      rum/traces:
        endpoint: 0.0.0.0:8026
        rum_data_type: traces
      zipkin:
        endpoint: '0.0.0.0:9411'
    service:
      extensions:
      - health_check
      - pprof
      pipelines:
        logs:
          exporters:
          - otlphttp/vector_logs
          processors:
          - resource/enrich_headers
          - batch/logs
          - groundcover/logs
          receivers:
          - loki
          - otlp
          - faro
          - awsfirehose
          - http
          - rum/logs
        logs/custom:
          exporters:
          - otlphttp/vector_custom
          processors:
          - batch/custom
          - groundcover/custom
          receivers:
          - otlp
          - rum/events
        logs/monitorState:
          exporters:
          - otlphttp/vector_monitors
          processors:
          - batch/monitorState
          - groundcover/monitorState
          receivers:
          - loki/historian
        logs/traces:
          exporters:
          - otlphttp/vector_traces
          receivers:
          - groundcover/traces2logs
        metrics:
          exporters:
          - prometheusremotewrite
          processors:
          - memory_limiter
          - batch
          receivers:
          - otlp
        traces:
          exporters:
          - groundcover/traces2logs
          processors:
          - batch/traces
          - groundcover/traces
          receivers:
          - otlp
          - datadog
          - faro
          - rum/traces
          - zipkin
      telemetry:
        metrics:
          readers:
          - pull:
              exporter:
                prometheus:
                  host: 0.0.0.0
                  port: 8888
