# Source: groundcover-wrapper/charts/groundcover/charts/backend/charts/keep/templates/backend.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: groundcover-keep-backend
  labels:
    helm.sh/chart: keep-0.1.67
    app.kubernetes.io/name: keep
    app.kubernetes.io/instance: groundcover
    app.kubernetes.io/version: 0.37.20
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/part-of: keep
    app.kubernetes.io/component: backend
    keep-component: backend
spec:
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: keep
      app.kubernetes.io/instance: groundcover
      keep-component: backend
  template:
    metadata:
      annotations:
        checksum/values: 1813c472466c2bc6e791e19eee864a4d7694c96fddccede3a2a2c6294a2970ad
        prometheus.io/path: /metrics/processing
        prometheus.io/port: "8080"
        prometheus.io/scrape: "true"
      labels:
        helm.sh/chart: keep-0.1.67
        app.kubernetes.io/name: keep
        app.kubernetes.io/instance: groundcover
        app.kubernetes.io/version: 0.37.20
        app.kubernetes.io/managed-by: Helm
        app.kubernetes.io/part-of: keep
        app.kubernetes.io/component: backend
        keep-component: backend
    spec:
      serviceAccountName: groundcover-keep
      securityContext: {}
      containers:
        - name: keep
          securityContext: {}
          image: public.ecr.aws/groundcovercom/keep-api:0.40.6.4
          imagePullPolicy: Always
          ports:
            - name: http
              containerPort: 8080
              protocol: TCP
          env:
            - name: KEEP_API_URL
              value: http://localhost:3000/backend
            - name: KEEP_USE_PROVIDER_CACHE
              value: "true"
            - name: KEEP_EXTRACT_IDENTITY
              value: "false"
            - name: KEEP_USE_LIMITER
              value: "true"
            - name: KEEP_LIMIT_CONCURRENCY
              value: 15/second
            - name: KEEP_NO_AUTH_METRICS
              value: "true"
            - name: KEEP_STORE_WORKFLOW_LOGS
              value: "false"
            - name: KEEP_ENRICHMENT_DISABLED
              value: "false"
            - name: KEEP_MAINTENANCE_WINDOWS_ENABLED
              value: "false"
            - name: KEEP_CORRELATION_ENABLED
              value: "false"
            - name: KEEP_PROVIDER_DISTRIBUTION_ENABLED
              value: "false"
            - name: KEEP_AUDIT_EVENTS_ENABLED
              value: "false"
            - name: KEEP_CALCULATE_START_FIRING_TIME_ENABLED
              value: "false"
            - name: KEEP_DEBUG_TASKS
              value: "true"
            - name: KEEP_ALERT_FIELDS_ENABLED
              value: "false"
            - name: CONSUMER
              value: "false"
            - name: KEEP_DEDUPLICATION_DISTRIBUTION_ENABLED
              value: "false"
            - name: KEEP_CUSTOM_DEDUPLICATION_ENABLED
              value: "false"
            - name: POSTHOG_DISABLED
              value: "true"
            - name: PROMETHEUS_MULTIPROC_DIR
              value: /tmp/prometheus
            - name: KEEP_PROVIDERS
              valueFrom:
                configMapKeyRef:
                  name: keep-config
                  key: provisionedProviders.json
            - name: CLICKHOUSE_PASS
              valueFrom:
                secretKeyRef:
                  name: groundcover-clickhouse
                  key: admin-password
            - name: PUSHER_DISABLED
              value: "true"
            - name: KEEP_IMPERSONATION_ENABLED
              value: "true"
            - name: KEEP_IMPERSONATION_AUTO_PROVISION
              value: "true"
            - name: SERVICE_NAME
              value: groundcover-keep-backend
            - name: OTLP_ENDPOINT
              value: https://traces.groundcover.com/v1/traces
            - name: OTLP_SPAN_EXPORTER
              value: http
            - name: TRACING_HEADERS_APIKEY
              valueFrom:
                secretKeyRef:
                  name: groundcover-token
                  key: token
            - name: OTEL_EXPORTER_OTLP_HEADERS
              value: apikey=$(TRACING_HEADERS_APIKEY)
            - name: SECRET_MANAGER_TYPE
              value: K8S
            - name: KEEP_DEFAULT_API_KEYS
              valueFrom:
                secretKeyRef:
                  name: keep-credentials
                  key: api-keys
            - name: AUTH_TYPE
              value: SINGLE_TENANT
            - name: KEEP_DEFAULT_USERNAME
              valueFrom:
                secretKeyRef:
                  name: keep-credentials
                  key: username
            - name: KEEP_DEFAULT_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: keep-credentials
                  key: password
            - name: DATABASE_POOL_SIZE
              value: "200"
            - name: K8S_NAMESPACE
              valueFrom:
                fieldRef:
                  fieldPath: metadata.namespace
            - name: DATABASE_CONNECTION_STRING
              valueFrom:
                secretKeyRef:
                  name: keep-postgres
                  key: connection_string
          volumeMounts:
            - name: state-volume
              mountPath: /state
              readOnly: false
          resources:
            limits:
              memory: 2Gi
            requests:
              cpu: 100m
              memory: 128Mi
      initContainers:
        - name: wait-for-db
          image: public.ecr.aws/groundcovercom/bitnami/postgresql:15.3.0-debian-11-r75
          command:
            - /bin/sh
            - -c
          args:
            - |
              pg_isready \
                -U "${POSTGRES_USERNAME}" \
                -d "dbname=${POSTGRES_DB_NAME}" \
                -h groundcover-postgresql \
                -p 5432
          env:
            - name: POSTGRES_USERNAME
              valueFrom:
                secretKeyRef:
                  key: username
                  name: keep-postgres
            - name: POSTGRES_DB_NAME
              valueFrom:
                secretKeyRef:
                  key: database
                  name: keep-postgres
      volumes:
        - name: state-volume
          emptyDir: {}
