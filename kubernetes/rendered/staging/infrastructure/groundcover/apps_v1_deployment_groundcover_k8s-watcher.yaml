# Source: groundcover-wrapper/charts/groundcover/templates/backend/k8s-watcher/deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  annotations:
    groundcover_version: 1.11.61
  labels:
    app.kubernetes.io/part-of: groundcover
    app: k8s-watcher
    app.kubernetes.io/name: k8s-watcher
  name: k8s-watcher
  namespace: groundcover
spec:
  selector:
    matchLabels:
      app: k8s-watcher
  template:
    metadata:
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "9102"
        groundcover_version: 1.11.61
        checksum/config: c928a9aa7cb5c5f372781e02ee219857b32d20b1e1fbd0cab704c714a33ae75b
      labels:
        app: k8s-watcher
        app.kubernetes.io/name: k8s-watcher
        app.kubernetes.io/part-of: groundcover
    spec:
      imagePullSecrets: []
      containers:
        - env:
            - name: GC_RUNNINGNAMESPACE
              valueFrom:
                fieldRef:
                  fieldPath: metadata.namespace
            - name: GC_GROUNDCOVERVERSION
              valueFrom:
                fieldRef:
                  fieldPath: metadata.annotations['groundcover_version']
            - name: API_KEY
              valueFrom:
                secretKeyRef:
                  key: token
                  name: groundcover-token
          envFrom:
            - secretRef:
                name: groundcover-config
          image: public.ecr.aws/groundcovercom/k8s-watcher:1.11.61
          imagePullPolicy: Always
          name: k8s-watcher
          ports:
            - containerPort: 9102
              name: watcher-metrics
            - containerPort: 8888
              name: watcher-http
          readinessProbe:
            failureThreshold: 20
            httpGet:
              path: /health
              port: watcher-http
              scheme: HTTP
            initialDelaySeconds: 45
            periodSeconds: 15
          livenessProbe:
            failureThreshold: 20
            httpGet:
              path: /health
              port: watcher-http
              scheme: HTTP
            initialDelaySeconds: 45
            periodSeconds: 15
          resources:
            limits:
              cpu: 500m
              memory: 1024Mi
            requests:
              cpu: 10m
              memory: 256Mi
          volumeMounts:
            - mountPath: /config
              name: k8s-watcher-config-volume
      initContainers:
        - name: check-ingestion-endpoint-ready
          env:
            - name: API_KEY
              valueFrom:
                secretKeyRef:
                  key: token
                  name: groundcover-token
          args:
            - |
              while [ $(curl -H "apikey:$API_KEY" \
                -k \
                -sw '%{http_code}' http://groundcover-vector:8686/health -o /dev/null) -ne 200 ];
              do
                echo 'Waiting for ingestion endpoint...';
                sleep 2;
              done;
              echo ingestion endpoint is up
          command:
            - /bin/sh
            - -c
          image: public.ecr.aws/groundcovercom/curl:8.6.0
        - name: check-metrics-ingestor-ready
          env:
            - name: API_KEY
              valueFrom:
                secretKeyRef:
                  key: token
                  name: groundcover-token
          args:
            - |
              while [ $(curl -H "apikey:$API_KEY" \
                -k \
                -sw '%{http_code}' http://groundcover-metrics-ingester:8429/api/v1/write -o /dev/null) -ne 204 ];
              do
                echo 'Waiting for VictoriaMetrics Agent...';
                sleep 2;
              done;
              echo VictoriaMetrics Agent is up
          command:
            - /bin/sh
            - -c
          image: public.ecr.aws/groundcovercom/curl:8.6.0
      serviceAccountName: k8s-watcher
      volumes:
        - configMap:
            name: k8s-watcher-config
          name: k8s-watcher-config-volume
