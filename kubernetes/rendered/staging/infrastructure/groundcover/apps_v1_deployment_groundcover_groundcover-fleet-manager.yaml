# Source: groundcover-wrapper/charts/groundcover/templates/backend/fleet-manager/deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  annotations:
    groundcover_version: 1.11.61
  labels:
    app.kubernetes.io/part-of: groundcover
    app: fleet-manager
  name: groundcover-fleet-manager
  namespace: groundcover
spec:
  replicas: 2
  selector:
    matchLabels:
      app: fleet-manager
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxUnavailable: 0
      maxSurge: 1
  template:
    metadata:
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "9102"
        groundcover_version: 1.11.61
        checksum/config: 0a870a30d0846c5cd3b5da63ae129bb5951f2199e1edc669ce6dd75d1ad4871a
      labels:
        app: fleet-manager
        app.kubernetes.io/name: fleet-manager
        app.kubernetes.io/part-of: groundcover
    spec:
      imagePullSecrets: []
      topologySpreadConstraints:
        - labelSelector:
            matchLabels:
              app.kubernetes.io/name: fleet-manager
          maxSkew: 1
          topologyKey: kubernetes.io/hostname
          whenUnsatisfiable: ScheduleAnyway
      containers:
        - env:
            - name: GC_RUNNINGNAMESPACE
              valueFrom:
                fieldRef:
                  fieldPath: metadata.namespace
            - name: GC_GROUNDCOVERVERSION
              valueFrom:
                fieldRef:
                  fieldPath: metadata.annotations['groundcover_version']
            - name: GC_CONFIGMANAGER_DB_PASS
              valueFrom:
                secretKeyRef:
                  name: groundcover-postgresql
                  key: postgres-password
            - name: API_KEY
              valueFrom:
                secretKeyRef:
                  key: token
                  name: groundcover-token
          envFrom:
            - secretRef:
                name: groundcover-config
          image: public.ecr.aws/groundcovercom/fleet-manager:1.11.61
          imagePullPolicy: Always
          name: fleet-manager
          ports:
            - containerPort: 8080
              name: manage-http
            - containerPort: 8081
              name: health-http
            - containerPort: 9102
              name: fleet-metrics
          readinessProbe:
            httpGet:
              scheme: HTTP
              path: /health
              port: health-http
            initialDelaySeconds: 10
            periodSeconds: 15
            failureThreshold: 20
          livenessProbe:
            httpGet:
              scheme: HTTP
              path: /health
              port: health-http
            initialDelaySeconds: 10
            periodSeconds: 15
            failureThreshold: 20
          resources:
            limits:
              cpu: 500m
              memory: 512Mi
            requests:
              cpu: 100m
              memory: 128Mi
          volumeMounts:
            - mountPath: /config
              name: fleet-manager-config-volume
      initContainers:
        - name: wait-for-db
          image: public.ecr.aws/groundcovercom/bitnami/postgresql:15.3.0-debian-11-r75
          env:
            - name: POSTGRES_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: groundcover-postgresql
                  key: postgres-password
          command:
            - /bin/sh
            - -c
          args:
            - |
              pg_isready \
                -U "postgres" \
                -d "dbname=postgres" \
                -h groundcover-postgresql \
                -p 5432
      volumes:
        - configMap:
            name: fleet-manager-config
          name: fleet-manager-config-volume
