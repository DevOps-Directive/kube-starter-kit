# Source: groundcover-wrapper/charts/groundcover/templates/backend/portal/deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  annotations:
    groundcover_version: 1.11.61
  labels:
    app.kubernetes.io/part-of: groundcover
    app: portal
    app.kubernetes.io/name: portal
  name: groundcover-portal
  namespace: groundcover
spec:
  selector:
    matchLabels:
      app: portal
  strategy:
    type: Recreate
  template:
    metadata:
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "9102"
        groundcover_version: 1.11.61
        checksum/config: f27d168f60439aa4e62e52a277b493ad4899e3a1938747c34a74847d31b32280
      labels:
        app: portal
        app.kubernetes.io/name: portal
        app.kubernetes.io/part-of: groundcover
    spec:
      imagePullSecrets: []
      serviceAccountName: groundcover-portal
      containers:
        - env:
            - name: GC_GROUNDCOVERVERSION
              valueFrom:
                fieldRef:
                  fieldPath: metadata.annotations['groundcover_version']
            - name: GC_MONITORSMANAGER_ENABLED
              value: "true"
            - name: GC_MONITORSMANAGER_URL
              value: http://groundcover-monitors-manager:80
            - name: GC_MONITORSMANAGER_USERNAME
              valueFrom:
                secretKeyRef:
                  key: admin-user
                  name: groundcover-monitors-manager
            - name: GC_MONITORSMANAGER_PASSWORD
              valueFrom:
                secretKeyRef:
                  key: admin-password
                  name: groundcover-monitors-manager
            - name: GC_WORKFLOWS_ENABLED
              value: "true"
            - name: GC_WORKFLOWS_URL
              value: http://groundcover-keep-backend:8080
            - name: GC_WORKFLOWS_APIKEY
              valueFrom:
                secretKeyRef:
                  optional: true
                  key: admin-api-key
                  name: keep-credentials
            - name: GC_ROUTER_TOKEN
              valueFrom:
                secretKeyRef:
                  key: token
                  name: groundcover-token
            - name: GC_TRACING_HEADERS_APIKEY
              valueFrom:
                secretKeyRef:
                  key: token
                  name: groundcover-token
            - name: GC_CLICKHOUSE_PASS
              valueFrom:
                secretKeyRef:
                  key: admin-password
                  name: groundcover-clickhouse
            - name: GC_CLICKHOUSE_HOST
              value: groundcover-clickhouse-shard0-0-external
          envFrom:
            - secretRef:
                name: groundcover-config
          image: public.ecr.aws/groundcovercom/portal:1.11.61
          imagePullPolicy: Always
          name: groundcover-portal
          ports:
            - containerPort: 5555
              name: grpc-portal
              protocol: TCP
            - containerPort: 9102
              name: portal-metrics
            - containerPort: 9999
              name: portal-http
              protocol: TCP
          readinessProbe:
            httpGet:
              path: /health
              port: portal-http
            initialDelaySeconds: 5
            periodSeconds: 15
          livenessProbe:
            httpGet:
              scheme: HTTP
              path: /health
              port: portal-http
            initialDelaySeconds: 5
            periodSeconds: 15
            timeoutSeconds: 5
          resources:
            limits:
              memory: 128Mi
            requests:
              cpu: 5m
              memory: 64Mi
          volumeMounts:
            - mountPath: /config
              name: portal-config-volume
      volumes:
        - configMap:
            name: groundcover-portal-config
          name: portal-config-volume
