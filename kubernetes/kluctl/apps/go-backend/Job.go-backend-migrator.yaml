apiVersion: batch/v1
kind: Job
metadata:
  name: go-backend-migrate
  namespace: apps
  annotations:
    kluctl.io/hook: pre-deploy
    # kluctl.io/hook-weight: 1 # use ascending hook weight if resources need to exist in order
spec:
  ttlSecondsAfterFinished: 3600 # GC old Jobs
  template:
    spec:
      restartPolicy: Never
      containers:
        - name: apply
          image: 857059614049.dkr.ecr.us-east-2.amazonaws.com/services/go-backend/migrations:52e9e33a82f73e4cce1892886237c0dac9f3de3a
          args:
            [
              "migrate",
              "apply",
              "--dir",
              "file://migrations",
              "--url",
              "$(DATABASE_URL)",
            ]
          env:
            - name: DATABASE_URL
              value: "postgresql://app:0K8xJ9mKqljmwUHpIX5jpuoZHFmJVNnYvoOHOxai04GYUE0mPXp9MXbaRnJGc37C@go-backend-pg-rw.apps.svc.cluster.local:5432/app"
