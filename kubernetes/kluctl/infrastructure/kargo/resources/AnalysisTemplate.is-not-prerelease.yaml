apiVersion: argoproj.io/v1alpha1
kind: AnalysisTemplate
metadata:
  name: is-not-prerelease
  namespace: kube-starter-kit
spec:
  args:
    - name: IMAGE_TAG
  metrics:
    - name: is-not-prerelease
      provider:
        job:
          spec:
            backoffLimit: 1
            template:
              spec:
                containers:
                  - args:
                      - |
                        set -euo pipefail
                        echo "============================="
                        echo "Running prerelease check"
                        echo "IMAGE_TAG: ${IMAGE_TAG}"
                        echo "-----------------------------"

                        # Check if tag matches strictly X.Y.Z (no '-' prerelease suffix)
                        if echo "${IMAGE_TAG}" | grep -Eq '^[0-9]+\.[0-9]+\.[0-9]+$'; then
                          echo "✅ Version is stable (matches X.Y.Z)"
                          echo "Exit code: 0"
                          echo "============================="
                          exit 0
                        else
                          echo "❌ Version is not stable (contains prerelease or invalid format)"
                          echo "Exit code: 1"
                          echo "============================="
                          exit 1
                        fi
                    command:
                      - /bin/sh
                      - -c
                    env:
                      - name: IMAGE_TAG
                        value: "{{args.IMAGE_TAG}}"
                    image: alpine:3.20
                    name: is-not-prerelease
                restartPolicy: Never
