[tasks.create-deploy-key]
description = "Generate SSH deploy key and create ArgoCD repository secret"
usage = '''
arg "<repo_url>" help="Git repository URL (e.g., git@github.com:org/repo.git)"
'''
run = """
#!/usr/bin/env bash
set -euo pipefail

REPO_URL="${usage_repo_url}"
SECRET_NAME="repo-kube-starter-kit"

# Check if secret already exists
if kubectl get secret "${SECRET_NAME}" -n argocd &>/dev/null; then
  echo "Warning: Secret '${SECRET_NAME}' already exists in namespace 'argocd'."
  echo "To rotate the key, delete the secret first:"
  echo "  kubectl delete secret ${SECRET_NAME} -n argocd"
  exit 1
fi

KEY_FILE=$(mktemp)
trap "rm -f ${KEY_FILE} ${KEY_FILE}.pub" EXIT

# Generate ED25519 SSH key
ssh-keygen -t ed25519 -f "${KEY_FILE}" -N "" -C "argocd-deploy-key" -q

PRIVATE_KEY=$(cat "${KEY_FILE}")
PUBLIC_KEY=$(cat "${KEY_FILE}.pub")

# Create namespace if it doesn't exist
kubectl create namespace argocd --dry-run=client -o yaml | kubectl apply -f -

# Create the repository secret
kubectl create secret generic "${SECRET_NAME}" \\
  --namespace argocd \\
  --from-literal=type=git \\
  --from-literal=url="${REPO_URL}" \\
  --from-literal=sshPrivateKey="${PRIVATE_KEY}" \\
  --dry-run=client -o yaml | \\
kubectl label --local -f - argocd.argoproj.io/secret-type=repository -o yaml | \\
kubectl apply -f -

echo ""
echo "Created secret '${SECRET_NAME}' in namespace 'argocd'"
echo ""
echo "┌─────────────────────────────────────────────────────────────────────────────┐"
echo "│ GitHub Deploy Key Setup                                                     │"
echo "├─────────────────────────────────────────────────────────────────────────────┤"
echo "│ 1. Go to your repository Settings -> Deploy keys -> Add deploy key         │"
echo "│ 2. Title: ArgoCD Deploy Key                                                 │"
echo "│ 3. Paste the public key below                                               │"
echo "│ 4. Leave 'Allow write access' unchecked                                     │"
echo "├─────────────────────────────────────────────────────────────────────────────┤"
echo "│ Public Key:                                                                 │"
echo "│   ${PUBLIC_KEY}"
echo "└─────────────────────────────────────────────────────────────────────────────┘"
"""

[tasks.install-argocd]
description = "Install ArgoCD and apply the app-of-apps"
usage = '''
arg "<cluster>" help="Target cluster" {
  choices "staging" "production"
}
'''
run = """
#!/usr/bin/env bash
set -euo pipefail

CLUSTER="${usage_cluster}"
ARGOCD_DIR="../rendered/${CLUSTER}/infrastructure/argocd"
APP_OF_APPS_DIR="../rendered/${CLUSTER}/argocd/argocd"

echo "Installing ArgoCD for cluster: ${CLUSTER}"
echo ""

# Step 1: Apply ArgoCD infrastructure (may need two passes for CRDs)
echo "Applying ArgoCD manifests..."
kubectl apply -f "${ARGOCD_DIR}" 2>&1 | grep -v "no matches for kind" || true
kubectl apply -f "${ARGOCD_DIR}"

echo ""
echo "Waiting for ArgoCD deployments to be available..."
kubectl wait --for=condition=available deployment --all -n argocd --timeout=300s

# Step 2: Apply AppProjects first
echo ""
echo "Applying AppProjects..."
for f in "${APP_OF_APPS_DIR}"/argoproj.io_v1alpha1_appproject_*.yaml; do
  kubectl apply -f "$f"
done

# Step 3: Apply Applications
echo ""
echo "Applying Applications..."
for f in "${APP_OF_APPS_DIR}"/argoproj.io_v1alpha1_application_*.yaml; do
  kubectl apply -f "$f"
done

echo ""
echo "ArgoCD bootstrap complete!"
echo ""
echo "ArgoCD will now sync and deploy all infrastructure components automatically."
echo ""
echo "To access the ArgoCD UI:"
echo "  kubectl port-forward svc/argocd-server -n argocd 8080:443"
echo ""

# Wait for initial admin secret to be created (ArgoCD server creates this on startup)
echo "Waiting for initial admin secret..."
for i in {1..30}; do
  if kubectl get secret argocd-initial-admin-secret -n argocd &>/dev/null; then
    ADMIN_PASSWORD=$(kubectl get secret argocd-initial-admin-secret -n argocd -o jsonpath='{.data.password}' | base64 -d)
    echo ""
    echo "Admin credentials:"
    echo "  Username: admin"
    echo "  Password: ${ADMIN_PASSWORD}"
    exit 0
  fi
  sleep 2
done

echo ""
echo "Note: Initial admin secret not yet available."
echo "The ArgoCD server may still be initializing. To get the password later:"
echo "  kubectl get secret argocd-initial-admin-secret -n argocd -o jsonpath='{.data.password}' | base64 -d"
"""
