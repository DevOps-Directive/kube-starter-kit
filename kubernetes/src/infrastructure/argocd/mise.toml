[env]
OUTPUT_PATH = "infrastructure/argocd"

[tasks]

install = '''
helm upgrade --install \
  --values values.yaml \
  -n argocd \
  --create-namespace \
  argocd argo/argo-cd
'''

template = '''
helm template \
  --values values.yaml \
  -n argocd \
  argocd argo/argo-cd > templated.yaml
'''

argo-login = '''
argocd login argocd.staging.kubestarterkit.com --sso 
'''

[tasks.render-cluster]
description = "Render manifests for specified cluster"
usage = '''
arg "<cluster>" help="Target cluster" {
  choices "staging" "production"
}
'''
run = """
#!/usr/bin/env bash
set -euo pipefail

export OUTPUT_DIR="${PWD}/../../../rendered/${usage_cluster}/${OUTPUT_PATH}"

mise run //tools:render:prep-output-dir "${OUTPUT_DIR}"

helm template --release-name argocd . \
  --namespace argocd \
  --values values.yaml \
  --values values.${usage_cluster}.yaml \
  | mise run //tools:render:split-k8s-docs ${OUTPUT_DIR}
"""
