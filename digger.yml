workflows:
  default:
    plan:
      steps:
        - run: echo "Starting plan step"
        - init
        - plan
    apply:
      steps:
        - run: echo "Starting apply step"
        - init
        - apply
    workflow_configuration:
      on_pull_request_pushed: ["digger plan"]
      on_pull_request_closed: ["digger unlock"]
      on_commit_to_default: ["digger unlock"]
      skip_merge_check: true # Potential extension: Let Dev Apply before the branch is mergable (need to split out prod to enable this)

generate_projects:
  blocks:
    # terraform/live/{env}/{region}/{project}
    # Excludes: .terraform dirs, prod/**, staging/us-east-1/** (examples only - not deployed)
    - include: "terraform/live/*/*/**"
      exclude: "{**/.terraform/**,**/prod/**,**/staging/us-east-1/**}"
      root_dir: "terraform/live/"
      terragrunt: true
      workflow: "default"
      workflow_file: digger-workflow.yml
      # NOTE: include_patterns are only evaluated if at least one project has a change within it.
      #       added `terraform/live/shared/global/force-plan-no-op` as a hacky workaround to force a
      #       digger plan workflow to be triggered when only modifying a module and not a project directly.
      # include_patterns:
      #   - terraform/live/shared/global/force-plan-no-op/**
      #   - terraform/modules/**
      #   - digger.yml
