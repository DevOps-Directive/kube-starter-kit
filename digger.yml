workflows:
  default:
    plan:
      steps:
        - run: echo "Starting plan step"
        - init
        - plan
    apply:
      steps:
        - run: echo "Starting apply step"
        - init
        # can change back to `- apply` after https://github.com/diggerhq/digger/pull/2332 is merged
        - run: terragrunt apply -lock-timeout=3m -auto-approve $DIGGER_PLANFILE
    workflow_configuration:
      on_pull_request_pushed: ["digger plan"]
      on_pull_request_closed: ["digger unlock"]
      on_commit_to_default: ["digger unlock"]
      skip_merge_check: true # Let Dev Apply before the branch is mergable (TODO: split out prod and enforce this)

generate_projects:
  blocks:
    # terraform/live/{env}/{region}/{project}
    - include: "terraform/live/*/*/**"
      exclude: "**/.terraform/**"
      root_dir: "terraform/live/"
      terragrunt: true
      workflow: "default"
