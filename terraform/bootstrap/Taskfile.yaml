version: "3"

tasks:
  create-state-bucket:
    desc: Create an S3 bucket for Terraform state
    cmds:
      - cmd: |
          set -euo pipefail
          if [ -z "{{.BUCKET_NAME}}" ] || [ -z "{{.AWS_REGION}}" ]; then
            echo "Usage: task create-state-bucket BUCKET_NAME=my-tf-state-bucket AWS_REGION=us-east-2" && exit 1
          fi

          echo "BUCKET_NAME: {{ .BUCKET_NAME }}"
          echo "AWS_REGION: {{ .AWS_REGION }}"

          if [ "{{ .AWS_REGION }}" = "us-east-1" ]; then
            aws s3api create-bucket \
              --bucket "{{ .BUCKET_NAME }}" \
              --region "{{ .AWS_REGION }}"
          else
            aws s3api create-bucket \
              --bucket "{{ .BUCKET_NAME }}" \
              --region "{{ .AWS_REGION }}" \
              --create-bucket-configuration LocationConstraint="{{ .AWS_REGION }}"
          fi

  create-terraform-iam-role-in-target-account:
    desc: Create an IAM role that is assumable from infrastructure SSO role
    cmds:
      - cmd: |
          set -euo pipefail
          if [ -z "{{.ROLE_NAME}}" ]; then
            echo "Usage: task create-terraform-iam-role-in-target-account ROLE_NAME=my-admin-role" && exit 1
          fi

          echo "ROLE_NAME: {{.ROLE_NAME}}"

          ROLE_NAME="$(aws sts get-caller-identity --query 'Arn' --output text | awk -F'/' '{print $2}')"
          SSO_ROLE_ARN="$(aws iam get-role --role-name "$ROLE_NAME" --query 'Role.Arn' --output text)"    

          tmpfile=$(mktemp)
          jq --arg arn "$SSO_ROLE_ARN" '
            .Statement[0].Principal.AWS = [$arn]
          ' trust-policy.json.TEMPLATE > "$tmpfile"

          aws iam create-role \
            --role-name {{.ROLE_NAME}} \
            --assume-role-policy-document file://$tmpfile

          aws iam attach-role-policy \
            --role-name {{.ROLE_NAME}} \
            --policy-arn arn:aws:iam::aws:policy/AdministratorAccess
