name: Image CVE Scan

on:
  schedule:
    - cron: "0 5 * * *" # Daily at 5 AM UTC (midnight EST)
  workflow_dispatch:
    inputs:
      environment:
        description: "Environment to scan (none = only additional_images)"
        type: choice
        options: ["production", "staging", "none"]
        default: "production"
      additional_images:
        description: "Additional images to scan (JSON array)"
        type: string
        default: "[]"

permissions:
  contents: read

jobs:
  extract-images:
    runs-on: ubuntu-24.04
    outputs:
      images: ${{ steps.extract.outputs.images }}
      matrix: ${{ steps.extract.outputs.matrix }}
    steps:
      - uses: actions/checkout@ff7abcd0c3c05ccf6adc123a8cd1fd4fb30fb493 # v5.0.0

      - name: Extract images
        id: extract
        env:
          ENVIRONMENT: ${{ inputs.environment || 'production' }}
          ADDITIONAL_IMAGES: ${{ inputs.additional_images || '[]' }}
        run: |
          images=$(.github/scripts/extract-images.sh \
            --environment "$ENVIRONMENT" \
            --additional-file ".github/security/additional-images.yaml" \
            --additional-images "$ADDITIONAL_IMAGES")

          # Compact JSON to single line for GITHUB_OUTPUT
          images_compact=$(echo "$images" | jq -c '.')
          echo "images=$images_compact" >> "$GITHUB_OUTPUT"

          # Create matrix with unique IDs for artifact naming
          # Use index + short hash to guarantee uniqueness
          matrix=$(echo "$images" | jq -r '.[]' | nl -v 0 | while read idx img; do
            hash=$(echo -n "$img" | sha256sum | cut -c1-12)
            echo "{\"image\": \"$img\", \"id\": \"${idx}-${hash}\"}"
          done | jq -s '{include: .}' | jq -c '.')
          echo "matrix=$matrix" >> "$GITHUB_OUTPUT"

          # Log extracted images
          echo "### Extracted Images" >> "$GITHUB_STEP_SUMMARY"
          echo '```json' >> "$GITHUB_STEP_SUMMARY"
          echo "$images" | jq '.' >> "$GITHUB_STEP_SUMMARY"
          echo '```' >> "$GITHUB_STEP_SUMMARY"

  scan:
    needs: extract-images
    runs-on: ubuntu-24.04
    permissions:
      contents: read
      id-token: write # Required for AWS OIDC
    # NOTE: Currently runs 1 image per job for simplicity. If we approach the 256 job
    # limit or want to reduce per-job overhead (Syft/Grype downloads, Grype DB fetch,
    # ECR auth), consider sharding multiple images per job (e.g., 5-10 images per shard).
    strategy:
      matrix: ${{ fromJson(needs.extract-images.outputs.matrix) }}
      fail-fast: false # Continue scanning all images even if one fails
    steps:
      - name: Configure AWS credentials
        if: contains(matrix.image, '.dkr.ecr.')
        uses: aws-actions/configure-aws-credentials@7474bc4690e29a8392af63c5b98e7449536d5c3a # v4.3.1
        with:
          aws-region: us-east-2
          role-to-assume: arn:aws:iam::857059614049:role/ksk-gbl-ecr-bootstrap-github-oidc

      - name: Login to ECR
        if: contains(matrix.image, '.dkr.ecr.')
        uses: aws-actions/amazon-ecr-login@062b18b96a7aff071d4dc91bc00c4c1a7945b076 # v2.0.1
        with:
          mask-password: true

      - name: Generate SBOM with Syft
        id: syft
        uses: anchore/sbom-action@43a17d6e7add2b5535efe4dcae9952337c479a93 # v0.20.11
        with:
          image: ${{ matrix.image }}
          format: cyclonedx-json
          output-file: sbom.json
          upload-artifact: false
        continue-on-error: true

      - name: Scan SBOM with Grype
        id: grype
        if: steps.syft.outcome == 'success'
        uses: anchore/scan-action@3c9a191a0fbab285ca6b8530b5de5a642cba332f # v7.2.2
        with:
          sbom: sbom.json
          output-format: json
          fail-build: false
        continue-on-error: true

      - name: Prepare scan result
        id: result
        run: |
          mkdir -p results

          # Create result metadata
          result_file="results/result.json"

          if [[ "${{ steps.syft.outcome }}" != "success" ]]; then
            jq -n \
              --arg image "${{ matrix.image }}" \
              --arg status "sbom-failed" \
              --arg error "Failed to generate SBOM" \
              '{image: $image, status: $status, error: $error}' > "$result_file"
          elif [[ "${{ steps.grype.outcome }}" != "success" ]]; then
            jq -n \
              --arg image "${{ matrix.image }}" \
              --arg status "scan-failed" \
              --arg error "Failed to scan SBOM" \
              '{image: $image, status: $status, error: $error}' > "$result_file"
          else
            # Extract vulnerability counts from Grype output
            grype_output="${{ steps.grype.outputs.json }}"
            
            if [[ -f "$grype_output" ]]; then
              critical=$(jq '[.matches[]? | select(.vulnerability.severity == "Critical")] | length' "$grype_output")
              high=$(jq '[.matches[]? | select(.vulnerability.severity == "High")] | length' "$grype_output")
              medium=$(jq '[.matches[]? | select(.vulnerability.severity == "Medium")] | length' "$grype_output")
              low=$(jq '[.matches[]? | select(.vulnerability.severity == "Low")] | length' "$grype_output")
              negligible=$(jq '[.matches[]? | select(.vulnerability.severity == "Negligible")] | length' "$grype_output")
              unknown=$(jq '[.matches[]? | select(.vulnerability.severity == "Unknown" or .vulnerability.severity == null)] | length' "$grype_output")
              
              jq -n \
                --arg image "${{ matrix.image }}" \
                --arg status "success" \
                --argjson critical "$critical" \
                --argjson high "$high" \
                --argjson medium "$medium" \
                --argjson low "$low" \
                --argjson negligible "$negligible" \
                --argjson unknown "$unknown" \
                '{image: $image, status: $status, vulnerabilities: {critical: $critical, high: $high, medium: $medium, low: $low, negligible: $negligible, unknown: $unknown}}' > "$result_file"
              
              # Copy full Grype output for detailed artifact
              cp "$grype_output" "results/vulnerabilities.json"
            else
              jq -n \
                --arg image "${{ matrix.image }}" \
                --arg status "scan-failed" \
                --arg error "Grype output file not found" \
                '{image: $image, status: $status, error: $error}' > "$result_file"
            fi
          fi

          # Copy SBOM if it exists
          if [[ -f "sbom.json" ]]; then
            cp sbom.json "results/sbom.json"
          fi

          cat "$result_file"

      - name: Upload scan artifacts
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: scan-${{ matrix.id }}
          path: results/
          retention-days: 30

  report:
    needs: [extract-images, scan]
    runs-on: ubuntu-24.04
    if: always() # Run even if scan jobs fail
    steps:
      - name: Download all scan artifacts
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          pattern: scan-*
          path: all-results/

      - name: Debug artifacts
        run: |
          echo "=== Directory structure ==="
          find all-results/ -type f 2>/dev/null | head -20 || echo "No files found"
          echo ""
          echo "=== result.json files ==="
          for f in all-results/*/result.json; do
            if [[ -f "$f" ]]; then
              echo "--- $f ---"
              cat "$f"
            fi
          done

      - name: Generate report
        id: report
        run: |
          echo "## ðŸ” CVE Scan Report" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "**Environment:** ${{ inputs.environment || 'production' }}" >> "$GITHUB_STEP_SUMMARY"
          echo "**Scan Date:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"

          # Initialize counters
          total_critical=0
          total_high=0
          total_medium=0
          total_low=0
          total_negligible=0
          total_unknown=0
          failed_scans=0
          successful_scans=0

          # Create combined results file
          echo "[]" > combined-results.json

          # Process each result
          for result_dir in all-results/scan-*/; do
            if [[ -f "${result_dir}result.json" ]]; then
              result=$(cat "${result_dir}result.json")
              # Use temp file to avoid read/write race condition on combined-results.json
              jq --argjson new "$result" '. + [$new]' combined-results.json > combined-results.tmp
              mv combined-results.tmp combined-results.json

              status=$(echo "$result" | jq -r '.status')
              if [[ "$status" == "success" ]]; then
                ((successful_scans++)) || true
                total_critical=$((total_critical + $(echo "$result" | jq -r '.vulnerabilities.critical')))
                total_high=$((total_high + $(echo "$result" | jq -r '.vulnerabilities.high')))
                total_medium=$((total_medium + $(echo "$result" | jq -r '.vulnerabilities.medium')))
                total_low=$((total_low + $(echo "$result" | jq -r '.vulnerabilities.low')))
                total_negligible=$((total_negligible + $(echo "$result" | jq -r '.vulnerabilities.negligible')))
                total_unknown=$((total_unknown + $(echo "$result" | jq -r '.vulnerabilities.unknown')))
              else
                ((failed_scans++)) || true
              fi
            fi
          done

          # Summary statistics
          echo "### Summary" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "| Severity | Count |" >> "$GITHUB_STEP_SUMMARY"
          echo "|----------|-------|" >> "$GITHUB_STEP_SUMMARY"
          echo "| ðŸ”´ Critical | $total_critical |" >> "$GITHUB_STEP_SUMMARY"
          echo "| ðŸŸ  High | $total_high |" >> "$GITHUB_STEP_SUMMARY"
          echo "| ðŸŸ¡ Medium | $total_medium |" >> "$GITHUB_STEP_SUMMARY"
          echo "| ðŸ”µ Low | $total_low |" >> "$GITHUB_STEP_SUMMARY"
          echo "| âšª Negligible | $total_negligible |" >> "$GITHUB_STEP_SUMMARY"
          echo "| â“ Unknown | $total_unknown |" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "**Successful scans:** $successful_scans" >> "$GITHUB_STEP_SUMMARY"
          echo "**Failed scans:** $failed_scans" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"

          # Detailed results table
          echo "### Results by Image" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "| Image | Status | Critical | High | Medium | Low |" >> "$GITHUB_STEP_SUMMARY"
          echo "|-------|--------|----------|------|--------|-----|" >> "$GITHUB_STEP_SUMMARY"

          # Sort by critical desc, then high desc
          jq -r 'sort_by(-(.vulnerabilities.critical // 0), -(.vulnerabilities.high // 0)) | .[] |
            if .status == "success" then
              "| `\(.image)` | âœ… | \(.vulnerabilities.critical) | \(.vulnerabilities.high) | \(.vulnerabilities.medium) | \(.vulnerabilities.low) |"
            else
              "| `\(.image)` | âŒ \(.error // .status) | - | - | - | - |"
            end' combined-results.json >> "$GITHUB_STEP_SUMMARY"

          echo "" >> "$GITHUB_STEP_SUMMARY"

          # Set outputs for workflow status
          echo "failed_scans=$failed_scans" >> "$GITHUB_OUTPUT"
          echo "total_critical=$total_critical" >> "$GITHUB_OUTPUT"
          echo "total_high=$total_high" >> "$GITHUB_OUTPUT"

      - name: Upload combined report
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: cve-scan-report
          path: combined-results.json
          retention-days: 90

      - name: Check for failures
        if: steps.report.outputs.failed_scans != '0'
        run: |
          echo "::error::${{ steps.report.outputs.failed_scans }} image(s) failed to scan"
          exit 1
