---
title: 'Bootstrap Accounts'
description: 'Set up AWS IAM roles and import GitHub organization members'
icon: 'rocket'
---

## Overview

Before deploying infrastructure via CI/CD, you need to bootstrap your AWS accounts and GitHub organization for Terraform management. This is a one-time setup that creates the foundation for all automation.

### How Cross-Account Access Works

The **Infrastructure account** is the central hub for all Terraform operations:

```
GitHub Actions
       |
       | OIDC authentication
       v
+-------------------------------------------+
|          Infrastructure Account           |
|  +---------------+  +------------------+  |
|  | GitHub OIDC   |  | Terraform        |  |
|  | Role          |  | State Bucket     |  |
|  +---------------+  +------------------+  |
+-------------------------------------------+
       |
       | sts:AssumeRole (cross-account)
       v
+----------+  +----------+  +----------+  +----------+
|Management|  |   ECR    |  | Staging  |  |Production|
| Account  |  | Account  |  | Account  |  | Account  |
|          |  |          |  |          |  |          |
| IAM Role |  | IAM Role |  | IAM Role |  | IAM Role |
| (trusts  |  | (trusts  |  | (trusts  |  | (trusts  |
|  infra)  |  |  infra)  |  |  infra)  |  |  infra)  |
+----------+  +----------+  +----------+  +----------+
```

1. GitHub Actions authenticates via OIDC to a role in the Infrastructure account
2. That role assumes target account roles via cross-account IAM trust policies
3. Terraform runs with credentials for the target account, but state is stored centrally in the Infrastructure account

This pattern keeps credentials management simple (one OIDC integration) while maintaining proper account isolation.

### What Gets Bootstrapped

| Account | Resources Created |
|---------|-------------------|
| **Infrastructure** | S3 state bucket, GitHub OIDC provider, GitHub OIDC role |
| **All other accounts** | IAM role with trust policy allowing the Infrastructure account to assume it |

<Note>
For an overview of the multi-account structure and why it's designed this way, see [AWS Architecture](/features/03-aws-architecture).
</Note>

## Prerequisites

Before starting, you need:

- **AWS Organization** with member accounts created for each environment
- **[mise](https://mise.jdx.dev/)** installed (handles installing AWS CLI, jq, and other tools)
- **[Leapp](https://www.leapp.cloud/)** installed for AWS SSO authentication

### Required Accounts

Based on the [account structure](/features/03-aws-architecture#account-structure), you need these AWS accounts:

| Account | Purpose |
|---------|---------|
| **Management** | AWS Organizations, IAM Identity Center |
| **Infrastructure** | Terraform state, GitHub OIDC, CI/CD automation |
| **ECR** | Container registry (shared across environments) |
| **Staging** | Staging environment resources |
| **Production** | Production environment resources |

## Bootstrapping Steps

Bootstrapping involves two phases:

1. **Manual setup** (Steps 1-2): Run CLI commands locally to create the initial IAM roles and S3 bucket. This solves the chicken-and-egg problem where Terraform can't create the roles it needs to assume.

2. **Terraform takeover** (Steps 3-5): Once manual roles exist, Terraform can manage everything going forward, including importing the manually-created resources.

<Warning>
The manual commands in Steps 1-2 use scripts in `terraform/bootstrap/`. These must be run locally with AWS CLI credentials before any Terraform commands will work.
</Warning>

<Steps>
  <Step title="Create S3 state bucket and get SSO role ARN (manual)">
    The Infrastructure account is bootstrapped first because it hosts the Terraform state bucket that all accounts depend on.

    1. Log into the Infrastructure account using Leapp. Start the session for the Infrastructure account, which will set the `AWS_PROFILE` environment variable.

    2. Navigate to the bootstrap directory:
       ```bash
       cd terraform/bootstrap
       ```

    3. Create the S3 bucket for Terraform state:
       ```bash
       mise run create-state-bucket \
         --bucket-name ksk-gbl-infra-bootstrap-state \
         --aws-region us-east-2
       ```
       <Warning>
       Bucket names must be globally unique. Replace `ksk` with your organization's namespace.
       </Warning>

    4. Get your SSO role ARN (you'll need this for cross-account trust):
       ```bash
       mise run get-sso-role-arn
       ```
       Save this ARN, it looks like: `arn:aws:iam::ACCOUNT_ID:role/aws-reserved/sso.amazonaws.com/REGION/AWSReservedSSO_AdministratorAccess_XXXXX`
  </Step>

  <Step title="Create IAM roles in target accounts (manual)">
    Each target account needs an IAM role that can be assumed from the Infrastructure account. These roles must be created manually because Terraform can't assume a role that doesn't exist yet.

    Repeat these steps for each account (Management, ECR, Staging, Production):

    1. Log into the target account using Leapp. Start the session for the target account (e.g., Staging), which will set the `AWS_PROFILE` environment variable.

    2. Create the IAM role with cross-account trust:
       ```bash
       cd terraform/bootstrap

       mise run create-terraform-iam-role-in-target-account \
         --role-name ksk-gbl-staging-bootstrap-admin \
         --infra-sso-role-arn "arn:aws:iam::INFRA_ACCOUNT_ID:role/aws-reserved/sso.amazonaws.com/REGION/AWSReservedSSO_AdministratorAccess_XXXXX"
       ```

       This creates an IAM role with:
       - `AdministratorAccess` policy attached
       - Trust policy allowing the specified Infrastructure account role to assume it

    Use consistent naming for each account:
    | Account | Role Name |
    |---------|-----------|
    | Management | `ksk-gbl-mgmt-bootstrap-admin` |
    | ECR | `ksk-gbl-ecr-bootstrap-admin` |
    | Staging | `ksk-gbl-staging-bootstrap-admin` |
    | Production | `ksk-gbl-prod-bootstrap-admin` |

    <Note>
    These manually-created roles will be imported into Terraform state in the next step, so Terraform can manage them going forward.
    </Note>
  </Step>

  <Step title="Apply Terraform bootstrapping stacks (Terraform)">
    With manual IAM roles in place, Terraform can now take over. The bootstrapping stacks:
    - Import the manually-created S3 bucket and IAM roles into Terraform state
    - Create the GitHub OIDC provider and role in the Infrastructure account
    - Update target account IAM roles to also trust the GitHub OIDC role (not just your SSO role)
    - Create Route53 hosted zones for each environment

    1. Update the root configuration with your account-specific values:

       Edit `terraform/config.tm.hcl`:
       ```hcl
       globals {
         namespace = "ksk"  # Your organization namespace

         # GitHub OIDC role in Infrastructure account (this role assumes roles in other accounts)
         github_oidc_assume_role_arn = "arn:aws:iam::INFRA_ACCOUNT_ID:role/ksk-gbl-infra-bootstrap-github-oidc"

         # Your SSO admin role in Infrastructure account (for local Terraform runs)
         sso_admin_assume_role_arn = "arn:aws:iam::INFRA_ACCOUNT_ID:role/aws-reserved/sso.amazonaws.com/REGION/AWSReservedSSO_AdministratorAccess_XXXXX"

         # S3 backend in Infrastructure account (stores state for ALL accounts)
         backend_bucket = "ksk-gbl-infra-bootstrap-state"
         backend_region = "us-east-2"
       }
       ```

       These values define who can assume roles in target accounts:
       - `github_oidc_assume_role_arn`: Used by CI/CD pipelines
       - `sso_admin_assume_role_arn`: Used when running Terraform locally

    2. Update each target account's bootstrapping stack with its IAM role ARN in `config.tm.hcl` files.

    3. Initialize and apply the bootstrapping stacks in order:
       ```bash
       cd terraform

       # Infrastructure account bootstrapping (creates OIDC provider and state bucket)
       terramate run --tags infra:bootstrapping -- terraform init
       terramate run --tags infra:bootstrapping -- terraform apply

       # Management account bootstrapping
       terramate run --tags management:bootstrapping -- terraform init
       terramate run --tags management:bootstrapping -- terraform apply

       # ECR account bootstrapping
       terramate run --tags ecr:bootstrapping -- terraform init
       terramate run --tags ecr:bootstrapping -- terraform apply

       # Staging account bootstrapping
       terramate run --tags staging:bootstrapping -- terraform init
       terramate run --tags staging:bootstrapping -- terraform apply

       # Production account bootstrapping
       terramate run --tags prod:bootstrapping -- terraform init
       terramate run --tags prod:bootstrapping -- terraform apply
       ```

       <Tip>
       After the Infrastructure account stack runs, the GitHub OIDC role exists. The target account stacks then update their IAM roles' trust policies to allow both the SSO admin role AND the GitHub OIDC role to assume them.
       </Tip>
  </Step>

  <Step title="Configure GitHub repository secrets">
    GitHub Actions needs to know which role to authenticate to. This is always the GitHub OIDC role in the Infrastructure account, which then assumes roles in other accounts as needed.

    Add these secrets to your GitHub repository:

    | Secret | Value |
    |--------|-------|
    | `AWS_ROLE_ARN` | The GitHub OIDC role ARN in the Infrastructure account |
    | `AWS_REGION` | Your primary AWS region (e.g., `us-east-2`) |

    The GitHub OIDC role ARN has the format:
    ```
    arn:aws:iam::INFRA_ACCOUNT_ID:role/ksk-gbl-infra-bootstrap-github-oidc
    ```

    <Note>
    The Terraform provider configuration in each stack specifies which target account role to assume. GitHub Actions only needs the Infrastructure account role; cross-account access is handled by the provider's `assume_role` block.
    </Note>
  </Step>

  <Step title="Verify the setup">
    Confirm everything is working:

    1. Check that you can assume roles from the Infrastructure account:
       ```bash
       # From Infrastructure account credentials
       aws sts assume-role \
         --role-arn arn:aws:iam::STAGING_ACCOUNT_ID:role/ksk-gbl-staging-bootstrap-admin \
         --role-session-name test
       ```

    2. Verify Terraform state is accessible:
       ```bash
       cd terraform
       terramate run --tags staging:bootstrapping -- terraform init
       terramate run --tags staging:bootstrapping -- terraform plan
       ```

    3. Push a commit to trigger a CI workflow and verify GitHub Actions can authenticate.
  </Step>
</Steps>

## Import GitHub Organization Members

The kit uses Terraform to manage GitHub organization members and teams. Before running Terraform on the management stack, you need to import existing GitHub users into Terraform state.

<Steps>
  <Step title="List existing organization members">
    Use the GitHub CLI to list current members:

    ```bash
    gh api orgs/YOUR-ORG/members --jq '.[].login'
    ```
  </Step>

  <Step title="Import members into Terraform state">
    For each existing member, run an import command:

    ```bash
    cd terraform/live/shared/global/github-org
    
    terraform import 'github_membership.members["username"]' YOUR-ORG:username
    ```

    Repeat for each member in your organization.
  </Step>

  <Step title="Update the Terraform configuration">
    Ensure each imported member is defined in the Terraform configuration. See [User Management](/features/04-user-management) for the configuration format.
  </Step>
</Steps>

<Note>
If you skip this step, Terraform will attempt to remove existing members that aren't in its state, which could lock you out of your organization.
</Note>

## What Gets Created

### Infrastructure Account (Central Hub)

| Resource | Purpose |
|----------|---------|
| S3 bucket | Stores Terraform state for **all accounts** with versioning enabled |
| GitHub OIDC provider | Enables keyless authentication from GitHub Actions |
| GitHub OIDC IAM role | Role that GitHub Actions assumes; can then assume roles in other accounts |

### Each Target Account (Management, ECR, Staging, Production)

| Resource | Purpose |
|----------|---------|
| IAM role | Admin role with trust policy allowing the Infrastructure account's GitHub OIDC role and SSO admin role to assume it |
| Route53 hosted zone | DNS zone for the environment (e.g., `staging.example.com`); not created in Management or ECR accounts |

## Troubleshooting

### "Access Denied" when assuming cross-account role

The two-step authentication means there are two places trust can fail:

1. **GitHub → Infrastructure account**: Check the OIDC role trust policy
   ```bash
   # Run from Infrastructure account
   aws iam get-role --role-name ksk-gbl-infra-bootstrap-github-oidc \
     --query 'Role.AssumeRolePolicyDocument'
   ```

2. **Infrastructure account → Target account**: Check the target role trust policy
   ```bash
   # Run from target account (e.g., staging)
   aws iam get-role --role-name ksk-gbl-staging-bootstrap-admin \
     --query 'Role.AssumeRolePolicyDocument'
   ```

The target account's trust policy should include the Infrastructure account's GitHub OIDC role ARN as a trusted principal.

### "Bucket already exists" error

S3 bucket names are globally unique. If the bucket name is taken:
1. Choose a different name with your organization prefix
2. Update `backend_bucket` in `terraform/config.tm.hcl`
3. Update any hardcoded references in bootstrapping stacks

### GitHub Actions can't authenticate

1. Verify the OIDC provider exists in the Infrastructure account:
   ```bash
   aws iam list-open-id-connect-providers
   ```

2. Check the GitHub OIDC role trust policy allows your repository:
   ```bash
   aws iam get-role --role-name ksk-gbl-infra-bootstrap-github-oidc \
     --query 'Role.AssumeRolePolicyDocument'
   ```

3. Ensure the repository name in the trust policy matches exactly (case-sensitive, including organization name).

### State file in wrong location

All Terraform state is stored in the Infrastructure account's S3 bucket, regardless of which account the resources are in. If you see state errors:
1. Verify `backend_bucket` and `backend_region` in `terraform/config.tm.hcl`
2. Ensure the GitHub OIDC role has S3 permissions in the Infrastructure account
3. Check that the bucket exists and has the expected state files

## Next Steps

With accounts bootstrapped, proceed to [Configure Integrations](/usage/getting-started/04-configure-integrations) to set up AWS, GitHub, and Terramate Cloud integrations for CI/CD.
