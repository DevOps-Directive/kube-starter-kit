[tasks.create-cluster]
description = "Create KinD development cluster with stable network"
run = '''
#!/usr/bin/env bash
set -euo pipefail

# Ensure the kind network exists with a fixed subnet for stable LoadBalancer IPs
if ! docker network inspect kind &>/dev/null; then
  echo "Creating Docker network 'kind' with subnet 172.20.0.0/16..."
  docker network create --subnet=172.20.0.0/16 kind
else
  echo "Docker network 'kind' already exists"
fi

kind create cluster --config ./kind/cluster-config.yaml
./kind/create-local-registry.sh
'''

[tasks.cloud-provider-kind]
run = 'sudo cloud-provider-kind'
# Note: Running as container on host network doesn't create address, but running on kind network doesn't allow connecting to it
# run = 'docker run --rm --network host -v /var/run/docker.sock:/var/run/docker.sock registry.k8s.io/cloud-provider-kind/cloud-controller-manager:v0.9.0'

[tasks.delete-cluster]
description = "Delete KinD development cluster"
run = '''
kind delete cluster
'''

[tasks.tilt-up]
run = "tilt up --file ./tilt/Tiltfile"

# TODO: Use tmux to run + stop tilt & cloud-provider-kind together

[tasks.ingress-urls]
description = "Print sslip.io URLs for local services"
run = '''
echo "Service URLs (sslip.io):"
echo "  go-backend-kustomize: http://go-backend-kustomize.172-20-0-100.sslip.io"
echo "  go-backend-helm:      http://go-backend-helm.172-20-0-100.sslip.io"
echo "  go-backend-timoni:    http://go-backend-timoni.172-20-0-100.sslip.io"
'''
